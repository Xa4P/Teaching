---
title: "Practical assignment cost-effectiveness acceptability frontier - Solution"
author: "X. Pouwels"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Assignment and solutions  
```{r, echo = TRUE}
rm(list  = ls()) # clear environment
options(scipen = 999) # Disable scientific notations
library(tidyverse)
library(knitr)

df_thx <- readRDS("data_CEAF.rds") # Load data

kable(df_thx) # Show data frame
```
1. Look at the cost-effectiveness plane for the outcomes of strategies 1-9  
```{r, echo = TRUE}
ggplot(data = df_thx, aes(x = QALYs, Costs, colour = Treatment)) +
  geom_point() + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey") +
  ggtitle("Cost-effectiveness plane") +
  theme_bw()
```

1.a. Question: based on this graph, can you already tell which intervention is (extendedly) dominated?  
1.a. **Answer:** On this graph, you can see that 4 is dominated by 1, and that 2 and 5 are probably extendedly dominated by 7, and 6 extendedly dominated by 9.  
2. Calculate the fully incremental ICERs of these screening strategies against each other  
2.a. *To do so, use the method described in the paper from Paulden (literature list). Using for loops may be required. You can also perform this exercise using a pen and a paper.*  
3. Which interventions are dominated?   

```{r, echo = T}
# Order by increasing number of QALYs
df_thx <- df_thx[order(df_thx$QALYs),]

# Identify dominated strategies
df_thx$Dominated <- NA # create new column to identify dominated strategies

for (i in 1:(nrow(df_thx)-1)) {
  df_thx[i, "Dominated"] <- ifelse(df_thx[i + 1, "Costs"] < df_thx[i, "Costs"], 1, 0)
}
df_thx[nrow(df_thx), "Dominated"] <- 0 # strategies with highest health benefits cannot be dominated

kable(df_thx)
```
3. **Answer:** As you can see in the Table, intervention 4 is dominated, because its health benefits are lower than intervention 1, but its costs are higher.  
4. Which interventions are extendedly dominated?
```{r, echo = T, warnings = F}
# Calculate ICERs for non-dominated strategies.
df_thx$Ext_dominated <- NA # create new column to identify extendedly dominated strategies
df_thx$ICER <- NA # create new column to calculate ICERs identify extendedly dominated strategies

v_nondom <- which(df_thx$Dominated == 0) # vector of non-dominated strategies
df_thx[min(v_nondom), "Ext_dominated"] <- 0 # identify the first intervention in the comparison
df_thx[which(df_thx$Dominated == 1), "ICER"] <- "-"
df_thx[which(df_thx$Dominated == 1), "Ext_dominated"] <- "-"
df_thx[which(df_thx$Ext_dominated == 0), "ICER"] <- "-"

# Calculate ICERs
for (i in 2:length(v_nondom)) {
  df_thx[v_nondom[i], "ICER"] <- round((df_thx[v_nondom[i], "Costs"] -  df_thx[v_nondom[i-1], "Costs"]) / (df_thx[v_nondom[i], "QALYs"] -  df_thx[v_nondom[i-1], "QALYs"]),0)
}

df_thx$ICER <- as.numeric(as.character(df_thx$ICER))

# Determine extended dominance
for (i in 2:length(v_nondom)) {
    df_thx[v_nondom[i], "Ext_dominated"] <- ifelse(df_thx[v_nondom[i], "ICER"] == "-", 0,
                                       ifelse(df_thx[v_nondom[i], "ICER"] > df_thx[v_nondom[i + 1], "ICER"], 1, 0
                                       )
    )
    }

df_thx[nrow(df_thx), "Ext_dominated"] <- 0 # strategies with highest health benefits cannot be extendedly dominated
v_ext_dom <- df_thx[which(df_thx$Ext_dominated == 1), "Treatment"] # vector of extendedly dominated strategies

kable(df_thx, row.names = F)
```
The extendedly dominated strategies are: `r v_ext_dom`. Calculating the ICERs has to be reiterated without these strategies.

```{r, echo = T, warnings = F}
# Calculate ICERs for non-dominated strategies - second round
df_thx$ICER <- NA # clear ICER column

v_nondom <- which(df_thx$Dominated == 0 &
                    df_thx$Ext_dominated == 0) # vector of non-(extendedly) dominated strategies
df_thx[min(v_nondom), "Ext_dominated"] <- 0 # identify the first intervention in the comparison
df_thx[min(v_nondom), "ICER"] <- "-" # identify the first intervention in the comparison

df_thx[which(df_thx$Dominated == 1 | 
               df_thx$Ext_dominated == 1), "ICER"] <- "-"

# Calculate ICERs
for (i in 2:length(v_nondom)) {
  df_thx[v_nondom[i], "ICER"] <- round((df_thx[v_nondom[i], "Costs"] -  df_thx[v_nondom[i-1], "Costs"]) / (df_thx[v_nondom[i], "QALYs"] -  df_thx[v_nondom[i-1], "QALYs"]),0)
}

df_thx$ICER <- as.numeric(as.character(df_thx$ICER))

# Determine extended dominance
for (i in 2:length(v_nondom)) {
    df_thx[v_nondom[i], "Ext_dominated"] <- ifelse(df_thx[v_nondom[i], "ICER"] == "-", 0,
                                       ifelse(df_thx[v_nondom[i], "ICER"] > df_thx[v_nondom[i+1], "ICER"], 1, 0
                                       )
    )
    }
df_thx[nrow(df_thx), "Ext_dominated"] <- 0 # strategies with highest health benefits cannot be extendedly dominated

v_ext_dom_2 <- df_thx[which(df_thx$Ext_dominated == 1), "Treatment"] # vector of extendedly dominated strategies

kable(df_thx, row.names = F)
```
The extendedly dominated strategies are now: `r v_ext_dom_2`. Calculating the ICERs has to be reiterated without these strategies.

```{r, echo = T, warnings = F}
# Calculate ICERs for non-dominated strategies - second round
df_thx$ICER <- NA # clear ICER column

v_nondom <- which(df_thx$Dominated == 0 &
                    df_thx$Ext_dominated == 0) # vector of non-(extendedly) dominated strategies
df_thx[min(v_nondom), "Ext_dominated"] <- 0 # identify the first intervention in the comparison
df_thx[min(v_nondom), "ICER"] <- "-" # identify the first intervention in the comparison

df_thx[which(df_thx$Dominated == 1 | 
               df_thx$Ext_dominated == 1), "ICER"] <- "-"

# Calculate ICERs
for (i in 2:length(v_nondom)) {
  df_thx[v_nondom[i], "ICER"] <- round((df_thx[v_nondom[i], "Costs"] -  df_thx[v_nondom[i-1], "Costs"]) / (df_thx[v_nondom[i], "QALYs"] -  df_thx[v_nondom[i-1], "QALYs"]),0)
}

df_thx$ICER <- as.numeric(as.character(df_thx$ICER))

# Determine extended dominance
for (i in 2:length(v_nondom)) {
    df_thx[v_nondom[i], "Ext_dominated"] <- ifelse(df_thx[v_nondom[i], "ICER"] == "-", 0,
                                       ifelse(df_thx[v_nondom[i], "ICER"] > df_thx[v_nondom[i+1], "ICER"], 1, 0
                                       )
    )
    }
df_thx[nrow(df_thx), "Ext_dominated"] <- 0 # strategies with highest health benefits cannot be extendedly dominated

v_ext_dom_3 <- df_thx[which(df_thx$Ext_dominated == 1), "Treatment"] # vector of extendedly dominated strategies

kable(df_thx, row.names = F)
```

Finally, the extendedly dominated strategies are: `r v_ext_dom_3`.

5. Which strategies are on the cost-effectiveness acceptability frontier?  
**Answer:** The strategies on the CEAF are: `r df_thx[which(df_thx$Dominated == 0 & df_thx$Ext_dominated == 0),"Treatment"]`

```{r, echo = TRUE}
ggplot(data = df_thx, aes(x = QALYs, Costs, colour = Treatment)) +
  geom_point() + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey") +
  geom_line(data = df_thx[which(df_thx$Dominated == 0 & df_thx$Ext_dominated == 0),], aes(x = QALYs, Costs), colour = "lightblue") +
  ggtitle("Cost-effectiveness plane with CEAF") +
  theme_bw()
```

6. Which intervention is optimal if the WTP threshold is equal to €20,000/QALY?    
**Answer:** The optimal intervention if the WTP threshold is €20,000/QALY is `r df_thx[max(which(df_thx$ICER <= 20000)), "Treatment"]`, because its ICER is `r df_thx[max(which(df_thx$ICER <= 20000)), "ICER"]`    
7. Which intervention is optimal if the WTP threshold is equal to €40,000/QALY?   
**Answer:** The optimal intervention if the WTP threshold is €40,000/QALY is `r df_thx[max(which(df_thx$ICER <= 40000)), "Treatment"]`, because its ICER is `r df_thx[max(which(df_thx$ICER <= 40000)), "ICER"]`    
8. Which intervention is optimal if the WTP threshold is equal to €100,000/QALY?   
**Answer:** The optimal intervention if the WTP threshold is €100,000/QALY is `r df_thx[max(which(df_thx$ICER <= 100000)), "Treatment"]`, because its ICER is `r df_thx[max(which(df_thx$ICER <= 100000)), "ICER"]`    
9. At which WTP threshold would intervention 5 be the optimal intervention?   
**Answer:** None because it is extendedly dominated.    
10. At which WTP threshold would intervention 8 be the optimal intervention?    
**Answer:** When the WTP threshold becomes €250,000/QALY or higher.    
11. Calculate the Net Monetary Benefit (NMB) for each intervention for a WTP threshold of €20,000/QALY. Which intervention has the highest NMB? Does this correspond with your answer to question 6?    
```{r, echo = T}
# Calculate NMBs
df_thx$NMB <- 20000 * df_thx$QALYs - df_thx$Costs
optim_strat <- df_thx[which(df_thx$NMB == max(df_thx$NMB)), "Treatment"]

kable(df_thx[order(df_thx$NMB, decreasing = TRUE), c("Treatment", "Name", "Costs", "QALYs", "NMB")],
      row.names = F,
      caption = "Net Monetary Benefits for each intervention, ordered in decreasing order")
```
**Answer:** The optimal intervention using the NMB and a WTP threshold is €20,000/QALY is `r optim_strat`. This answer is similar as the answer to question 6.       
